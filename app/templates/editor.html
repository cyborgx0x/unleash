{% extends "layout.html" %}
{% block title %}{{ fiction.name }} by {{fiction.author.name }}{% endblock %}

{% block layoutleft %}
<div  style="margin:5px">
    <div class="bg-dark text-white">
        <a class="dropdown-item" href="/u/{{current_user.id}}#your-fiction"> 
            <!-- Download SVG icon from http://tabler-icons.io/i/arrow-back-up -->
	        <button class=btn>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 13l-4 -4l4 -4m-4 4h11a4 4 0 0 1 0 8h-1" /></svg>   
                Trang qu·∫£n l√Ω
            </button>
        </a>
        <a class="dropdown-item" href="/fiction/{{fiction.id}}">Xem trang t√°c ph·∫©m</a>
        <button class="dropdown-item" onclick="showMedia(this)" value="edit-fiction">Ch·ªânh s·ª≠a th√¥ng tin</button>
        <button class="dropdown-item" onclick="showMedia(this)" value="manage-chapter">Qu·∫£n l√Ω ch∆∞∆°ng</button>
        <button class="dropdown-item" onclick="showMedia(this)" value="edit-foreword">Ch·ªânh s·ª≠a l·ªùi t·ª±a üìù</button>
        <button class="dropdown-item" onclick="showMedia(this)" value="fiction-configuration">C√†i ƒë·∫∑t chung</button>
        <button class="dropdown-item" onclick="showMedia(this)" value="fiction-media">Danh s√°ch Media</button>
        <button class="dropdown-item" onclick="showMedia(this)" value="fiction-statistic">Th·ªëng k√™</button>
        <button class="dropdown-item" onclick="showMedia(this)" value="fiction-history">L·ªãch s·ª≠ ch·ªânh s·ª≠a</button>
        <!-- <a href="/fiction/{{fiction.id}}/delete" class="dropdown-item">X√≥a t√°c ph·∫©m n√†y</a>  -->

    </div>
</div>
{% endblock %}
{% block layoutcenter %}

<div class="card"> 
    <div class="card-body">
        
        <div class="tab-content" id="tab-content">
            <div class="tab-pane" id="manage-chapter">
                <div>
                    <a  class="btn" href={{url_for('new_chapter', fiction_id=fiction.id)}}>T·∫°o Ch∆∞∆°ng M·ªõi</a>
                </div>
                <h2>B·∫•m v√†o link ƒë·ªÉ ch·ªânh s·ª≠a ch∆∞∆°ng</h2>
                {% for chapter in fiction.chapter %}
                <li class="dropdown-item">  
                    <a href="{{url_for('edit_chapter', chapter_id=chapter.id)}}" class="link-info large">{{chapter.name}}</a> 
                    <a href="{{url_for('delete_chapter', chapter_id=chapter.id)}}" style="position: relative; padding-left:30px ">X√≥a ch∆∞∆°ng n√†y</a>
                </li>                
                {% endfor %}
            </div>
            <div class="tab-pane" id="edit-foreword">
                <!-- <button type="button" class="btn btn-danger" onclick="loadEditor(this)" name="init-button" value="init">Load Editor</button> -->
                {% include "_editorjs.html"%}
            </div>
            <div class="tab-pane active show" id="edit-fiction">
                <div class="alert" role="alert" id="alert-theme">
                    <h4 class="alert-heading"  id="alert-information"> M·ªói m·ª•c ƒë·ªÅu ri√™ng bi·ªát. Khi ch·ªânh s·ª≠a xong vui l√≤ng nh·∫•n enter </h4>
                </div>
                <div class="form-group">
                    <label for="fiction_name">Ti√™u ƒë·ªÅ t√°c ph·∫©m</label>
                    <input type="text" class="form-control" name="fiction_name" id="fiction_name" value="{{fiction.name}}">
                    <label for="publist_year">NƒÉm xu·∫•t b·∫£n</label>
                    <input type="text" class="form-control" name="publish_year" id="publish_year" value="{{fiction.publish_year}}">
                    <label for="tag-manage">Th·ªÉ lo·∫°i</label>
                    <input type="text" name="tag-manage" id="tag-manage" value="{{fiction.tag}}" class="form-control">
                    <label for="link-download">Link t·∫£i s√°ch</label>
                    <input type="text" name="link-download" id="link-download" value="{{fiction.mediafire_link}}" class="form-control">
                    <label for="link-tiki">Tiki Link</label>
                    <input type="text" name="link-tiki" id="link-tiki" value="{{fiction.tiki_link}}" class="form-control">
                    <label for="book-cover">B√¨a s√°ch</label>
                    <input type="text" name="book-cover" id="book-cover" value="{{fiction.cover}}" class="form-control">
                    <label for="short-desc">M√¥ t·∫£ ng·∫Øn</label>
                    <input type="text" name="short-desc" id="short-desc" value="{{fiction.short_desc}}" class="form-control">
                    <label for="fiction-author">L·ª±a ch·ªçn T√°c gi·∫£</label>
                </div>
                
                <select name="fiction-author" id="fiction-author" class="form-control" aria-label="Fiction Author" >
                    {% for author in authors %}
                    {% if (author.id == fiction.author.id)%}
                        <option value="{{fiction.author.id}}" selected >{{fiction.author.name}}</option>
                        {% else %}
                        <option value="{{author.id}}">{{author.name}}</option>
                        {% endif %}
                    {% endfor %}
                </select>
            </div>
            <div class="tab-pane" id="fiction-media">
                <h1>Danh s√°ch media</h1>
                <ul>
                    {% for media in fiction.media %}
                    <li>
                        {{media.title}}
                    </li>
                    {% endfor %}
                </ul>
            </div>
            <div class="tab-pane" id="fiction-configuration">
                <script>
                    function saveContent(context) {
                        console.log(context.options[context.options.selectedIndex].value)
                        axios.post('', {type:context.name, value:context.options[context.options.selectedIndex].value})
                    }
                </script>
                <h1>C√†i ƒë·∫∑t chung</h1>
                <label for="fiction-status">Tr·∫°ng th√°i xu·∫•t b·∫£n</label>
                {% if fiction.status == "draft" %}
                <select name="fiction-status" id="fiction-status" class="form-control" aria-label="Fiction Status" onchange="saveContent(this)">
                    <option value="public">C√¥ng khai</option>
                    <option value="draft" selected>B·∫£n nh√°p</option>
                </select>
                {% else %}
                <select name="fiction-status" id="fiction-status" class="form-control" aria-label="Fiction Status" onchange="saveContent(this)">
                    <option value="public" selected>C√¥ng khai</option>
                    <option value="draft">B·∫£n nh√°p</option>
                </select>
                {% endif %}
                <label for="fiction-theme">L·ª±a ch·ªçn hi·ªÉn th·ªã</label>
                <select name="fiction-theme" id="fiction-theme" class="form-control" aria-label="Fiction Theme" onchange="saveContent(this)">
                    <option value="modern">Hi·ªán ƒë·∫°i</option>
                    <option value="classic" selected>C·ªï ƒëi·ªÉn</option>
                    <option value="creative">Ph√° c√°ch</option>
                </select>
            </div>
            <div class="tab-pane" id="fiction-history">
                <h1>L·ªãch s·ª≠ ch·ªânh s·ª≠a: </h1>
                <span class="badge bg-blue">c√≥ {{fiction.history | count}} l∆∞·ª£t ch·ªânh s·ª≠a</span>
                {{ fiction.history | pprint }}
               
                <table class="table table-dark">
                    <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Day</th>
                            <th scope="col">Who</th>
                            <th scope="col">Content</th>
                            <th scope="col">Type</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for history in fiction.history %}
                        <tr>
                            <th scope="row">{{loop.index}}</th>
                            <td>{{history.time}}</td>
                            <td>{{history.user.user_name}}</td>
                            <td>{{history.content}}</td>
                            <td>{{history.type}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
            </div>
            <div class="tab-pane" id="fiction-statistic">
                <h1> Tr·ª±c ti·∫øp </h1>

                    Bookmark Rightnow: 
                    {% for chapter in fiction.chapter %}
                    <span class="badge bg-pink">
                    {{ chapter.name }} -  {{chapter.bookmark | count }} bookmark
                    </span>
                    {% endfor %}
                <hr>
                <h1> To√†n th·ªùi gian </h1>
                {{fiction.view}} l∆∞·ª£t xem trang
                <br>
                <span class="badge bg-green">
                    has {{ fiction.like | count }} ‚ù§ heart  
                </span>
                <span class="badge bg-red">
                    has {{ fiction.media | count }} üì∑ media
                </span>
                <span class="badge bg-blue">
                    has {{ fiction.quote | count }} üìÑ quotes
                </span>
                <span class="badge bg-indigo">
                    has {{ fiction.chapter | count }} üìú chapter
                </span>

            </div>
        </div>
    </div>
</div>
<script>
    function loadEditor(context) {
        axios.post('', {type:context.value}).then((res)=>{
            let editor = res.data
            console.log(res.data)
            context.parentNode.innerHTML=editor
        })
    }
    let input = document.getElementById('edit-fiction').querySelectorAll('.form-control')
    console.log(input)
    for (let i=0; i<input.length;i++) {
        console.log(input[i])
        input[i].addEventListener('change', (e)=>{
            console.log(e.target.name)
            axios.post('', {type:e.target.name, value:e.target.value})
            .then((res)=>{
                console.log(res);
                document.getElementById('alert-information').textContent='Result: ' + res.data;
                document.getElementById('alert-theme').className = 'alert alert-success';
            })
            .catch((err)=>{
                console.log(err.message);
                document.getElementById('alert-information').textContent=err.message
                document.getElementById('alert-theme').className = 'alert alert-danger'
            })
        })
    }

</script>
{% endblock %}
{% block layoutright %}
<div class="card">
    <div class="card-body">
        
        <p>Khi ch·ªçn xu·∫•t ra t·ªáp epub, h·ªá th·ªëng s·∫Ω ki·ªÉm tra c√°c th√¥ng tin c·∫ßn thi·∫øt ƒë·ªÉ vi·ªác xu·∫•t b·∫£n t·ªáp ƒë∆∞·ª£c th√†nh c√¥ng. N·∫øu c√°c th√†nh ph·∫ßn kh√¥ng ƒë·∫°t, vi·ªác xu·∫•t ra t·ªáp epub s·∫Ω kh√¥ng ƒë∆∞·ª£c th·ª±c hi·ªán.</p>
        <button type="button" class="btn" name="export-fiction" value="epub-export" onclick="exportFiction(this)">Xu·∫•t ra t·ªáp epub</button>
        <script>
            
            function exportFiction(context){
                setTimeout(()=>sendMessage(context,"ƒêang ki·ªÉm tra th√¥ng tin c·∫ßn thi·∫øt"),1000)
                setTimeout(()=>sendMessage(context,"Ti√™u ƒë·ªÅ t√°c ph·∫©m ‚úÖ"),2000)
                setTimeout(()=>sendMessage(context,"B√¨a s√°ch ‚úÖ"),3000)
                setTimeout(()=>sendMessage(context,"T√°c gi·∫£ ‚úÖ"),4000)
                setTimeout(()=>sendMessage(context,"M√¥ t·∫£ ng·∫Øn ‚úÖ"),5000)
                setTimeout(()=>sendMessage(context,"L·ªùi t·ª±a ‚úÖ"),6000)
                setTimeout(()=>sendMessage(context,"ƒêang t·∫°o danh s√°ch ch∆∞∆°ng ‚úÖ"),7000)
                setTimeout(()=>sendMessage(context,"ƒê√£ t·∫°o xong, t·ªáp ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o drive üî•"),8000)
                setTimeout(()=>sendMessage(context,"Link s·∫Ω c√≥ s·∫µn ·ªü m·ª•c T·∫£i t·∫°i trang t√°c ph·∫©m ‚úÖ"),9000)
                setTimeout(()=>sendMessage(context,"B·∫°n c√≥ th·ªÉ b·∫•m n√∫t ƒë·ªÉ t·∫£i v·ªÅ ‚úÖ"),10000)
                setTimeout(()=>context.textContent = "üîΩ Download",10000)
                
            }
            function sendMessage(context,message) {
                context.previousElementSibling.textContent = message
            }
        </script>
    </div>
    <div class="card-body">
        <label for="reminder"> Jump to session:</label>
        <select name="reminder" id="reminder">
            <option value="reminder1">Note from Lucas</option>
            <option value="reminder1">Note 2 about character</option>
            <option value="reminder1">Note 3</option>
        </select>
    </div>
</div>
{% endblock %}