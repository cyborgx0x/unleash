<html>

<head>

  <title>{% block title %}{% endblock %} | Dreamer House</title>
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon" />

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BmbxuPwQa2lc/FVzBcNJ7UAyJxM6wuqIj61tLrc4wSX0szH/Ev+nYRRuWlolflfl" crossorigin="anonymous"> -->
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
    integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous">
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
    integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous">
  </script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
    integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous">
  </script>
  <!-- <script src="https://unpkg.com/@tabler/core@1.0.0-beta/dist/js/tabler.min.js"></script> -->
  <link rel="stylesheet" href="https://unpkg.com/@tabler/core@1.0.0-beta/dist/css/tabler.min.css">
  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">

  <style>

    .card:hover {
      box-shadow: 0 0 11px rgba(54, 28, 28, 0.2); 
    }
    .crop {
      object-fit: cover;
    }
    </style>
</head>

<body>
  <div class="wrapper">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-b5kHyXgcpbZJO/tY9Ul7kGkf1S0CWuKcCD38l8YkeH8z8QjE0GmW1gYU5S9FOnJ0" crossorigin="anonymous">
    </script>

    {% block nav %}{% endblock %}
    <header class="navbar navbar-expand-md navbar-dark navbar-overlap d-print-none">
      <div class="container-xl">
        <div class="navbar-expand-md">

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-menu">
            <span class="navbar-toggler-icon"></span>
          </button>
          <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
            <a href="{{ url_for('index')}}" style="text-decoration: none !important;" >
              Dreamer House
            </a>
          </h1>

        </div>
        
        <div class="navbar-nav order-md-last">
          
         
            
            
         
          <ul class='navbar-nav'>
            
              {% if current_user.is_anonymous %}
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('login') }}">Login</a>
              </li>
              {% else %}
              <li class="nav-item">
              <a class="nav-link" href="{{ url_for('user', username=current_user.user_name) }}">Profile</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{{ url_for('logout') }}">Logout</a>

              </li>
              {% endif %}
            
          </ul>

        </div>
        <div class="collapse navbar-collapse" id="navbar-menu">
          <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
            <div class="container-xl">
              

              <ul class="navbar-nav">
                <li class="nav-link">
                
                  <button type="button" class="btn" data-toggle="modal" data-target="#exampleModalCenter">
                            <!-- Download SVG icon from http://tabler-icons.io/i/circle-plus -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9" /><line x1="9" y1="12" x2="15" y2="12" /><line x1="12" y1="9" x2="12" y2="15" /></svg>
                            New Fic
                    </button>
                          
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('fictions') }}">
                    <span class="nav-link-title">
                      Fictions
                    </span>
                  </a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="{{ url_for('all_authors') }}">
                    <span class="nav-link-title">
                      Authors
                    </span>
                  </a>
                </li>

              </ul>

            </div>

          </div>
        </div>
      </div>
    </header>



    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <ul>
      {% for message in messages %}
      <li>{{ message }} </li>
      {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
    <div class="content">
      
      <div class="container-xl">
        
        <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    {% include '_form.html'  %} 
  </div>
        
<div class="input-icon" style="margin: 10;">
  <span class="input-icon-addon">
    <!-- Download SVG icon from http://tabler-icons.io/i/search -->
    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><circle cx="10" cy="10" r="7"></circle><line x1="21" y1="21" x2="15" y2="15"></line></svg>
  </span>
  <input id="searchbar" type="text" placeholder="Nhập từ khóa cần tìm kiếm" aria-placeholder="Bất cứ từ khóa nào" class="form-control"/>
  
</div>
<div id="searchresult"class="row row-card"></div>
<script src="https://unpkg.com/lunr/lunr.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>

  var indexfile =  getindexing('{{url_for("build_indexing")}}')
  async function getindexing(url) {
      return (
          axios.get(url).then(function(response) {
          return response.data;
      })).then(function(data){
         console.log(data)
          var idx = lunr( function () {
          this.ref('id')
          this.field('desc')
          this.field('name')
          this.field('tag')
          
          data.forEach(function (doc) {
              this.add(doc)
          }, this)
          })

          function createCover(src, alt, parents) {
              let cover = document.createElement('img')
              cover.src = "http://127.0.0.1:5000/img-cover/"+src
              cover.alt = alt
              parents.appendChild(cover)
          }
          function createCardBody(href, text, parents) {
            let displaysearch = document.createElement('div')
            displaysearch.className="card-body"
            let header = document.createElement('h5')
            header.className = "card-title"
            let link = document.createElement('a')
            link.href =  href
            link.textContent = text
            header.appendChild(link)
            displaysearch.appendChild(header)
            parents.appendChild(displaysearch)
          }
          function createParent(main) {
            let finalcard = document.createElement('div')
            finalcard.className="col-3"
            
            let parents = document.createElement('div')
            parents.className = "card"

            document.getElementById(main).appendChild(finalcard)
            finalcard.appendChild(parents)
            return parents
          }
          console.log(idx)
          searchbar = document.getElementById('searchbar')
          var keyword;
          searchbar.addEventListener('input', function(e) {
              let keyword=e.target.value
              if (keyword == '') {document.getElementById('searchresult').innerHTML=''}
              else {
                document.getElementById('searchresult').innerHTML=''
                var search = idx.search(keyword)
              search.forEach(function(searchresult) {
              console.log(searchresult)
              
              var indexitem;
              data.forEach(function(index) {
                  if (index.id == searchresult.ref) {
                      indexitem = index;
                  }
              })
              let href="/fiction/" + searchresult.ref;
              let text = indexitem.name
              let parents = createParent('searchresult')
              createCover(indexitem.cover, indexitem.name, parents)
              createCardBody(href,text, parents)
              
              })
              }
              
          })
          
      })
  }
  

</script>

        {% block content %}{% endblock %}
      </div>
    </div>
</body>

</html>